name: Terraform Apply

on:
 workflow_dispatch: # rÄ™czne odpalanie z UI


jobs:
 apply:
    runs-on: ubuntu-latest
    permissions:
        id-token: write
        contents: read
        deployments: write

    environment: production
    env:
      AWS_REGION: eu-north-1


    steps:
     - name: Checkout
       uses: actions/checkout@v4

     - name: Setup Terraform
       uses: hashicorp/setup-terraform@v3
       with:
         terraform_version: 1.9.8

     - name: Configure AWS credentials (Assume Apply Role)
       uses: aws-actions/configure-aws-credentials@v4
       with:
         role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/terraform_apply_role
         aws-region: ${{ env.AWS_REGION }}

     - name: Terraform init
       run: terraform init

     - name: Dowload plan artifact
       uses: action/download-artifact@v4
       with:
         name: tfplan
         path: .


     - name: Terraform Apply (form)
       run: terraform apply -auto-approve tfplan.binary